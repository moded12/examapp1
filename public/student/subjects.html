<!doctype html>
<html lang="ar" dir="rtl" class="notranslate" translate="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© â€” Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --hdrH:64px; --ftrH:56px; --bg-from:#eff6ff; --bg-to:#e5e7eb; --text:#0f172a; --footer:#0b1220; }
    .dark{ --bg-from:#0b1220; --bg-to:#0f172a; --text:#e5e7eb; --footer:#0b1220; }
    html,body{height:100%}
    body{ margin:0; font-family:'Tajawal',sans-serif; color:var(--text); background:linear-gradient(135deg,var(--bg-from),var(--bg-to)); padding-top:var(--hdrH); padding-bottom:calc(var(--ftrH) + 12px); }
    header.site-hd{ position:fixed; inset-inline:0; top:0; height:var(--hdrH); background:#ffffff; border-bottom:2px solid #dbeafe; z-index:30 }
    .dark header.site-hd{ background:#0f172a; border-bottom-color:#1e293b; }
    footer.site-ft{ position:fixed; inset-inline:0; bottom:0; height:var(--ftrH); background:var(--footer); color:#ffffff; display:flex; align-items:center; justify-content:center; z-index:20; }
    .row-btn{ width:100%; display:flex; align-items:center; justify-content:space-between; background:#1d4ed8; color:#fff; padding:14px 16px; border-radius:12px; box-shadow:0 8px 18px -10px rgba(29,78,216,.45); border:1px solid rgba(255,255,255,.25); transition:background .18s, transform .18s, box-shadow .18s; text-align:right; }
    .row-btn:hover{ background:#1b47c8; transform:translateY(-1px); box-shadow:0 12px 24px -14px rgba(29,78,216,.55) }
    .row-btn:focus{ outline:3px solid rgba(59,130,246,.55); outline-offset:2px }
    .row-btn .title{ font-weight:800; font-size:1.05rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-left:8px }
    .row-btn .chev{ font-size:18px; opacity:.95 }
    .terms-bar{ background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin-top:10px; }
    .dark .terms-bar{ background:#0f172a; border-color:#1f2937; }
    .pill{ background:#1d4ed8; color:#fff; padding:.5rem 1rem; border-radius:.7rem; font-weight:800; font-size:.95rem; transition:background .18s, transform .18s; display:inline-flex; align-items:center; gap:.4rem; }
    .pill:hover{ background:#1b47c8; transform:translateY(-1px) }
    .mode-btn{ background:#e2e8f0; color:#0f172a; padding:6px 10px; border-radius:10px; font-weight:700; }
    .mode-btn:hover{ background:#cbd5e1 } .dark .mode-btn{ background:#1f2937; color:#e5e7eb } .dark .mode-btn:hover{ background:#334155 }
  </style>
</head>
<body>
  <header class="site-hd">
    <div class="container mx-auto px-6 h-full flex items-center justify-between">
      <div class="flex items-center gap-2">
        <button id="goBackBtn" class="mode-btn !bg-slate-200 dark:!bg-slate-800" type="button" title="Ø±Ø¬ÙˆØ¹ Ø®Ø·ÙˆØ©">â¬…ï¸</button>
        <h1 class="text-lg md:text-2xl font-bold text-blue-800 dark:text-blue-300">ğŸ‡´ğŸ‡² Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù…Ù†Ù‡Ø§Ø¬ Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù†</h1>
      </div>
      <div class="flex items-center gap-3">
        <a id="homeLink" href="#" class="text-blue-700 dark:text-blue-300 hover:underline">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <button id="toggleTheme" class="mode-btn" type="button" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†">ğŸŒ™</button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-6 py-6">
    <div class="text-center mb-6">
      <h2 class="text-3xl md:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø©</h2>
      <div id="gradeHdr" class="mt-2 text-slate-700 dark:text-slate-300"></div>
      <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„/Ø§Ù„Ø«Ø§Ù†ÙŠ Ø£Ø³ÙÙ„Ù‡Ø§.</p>
    </div>

    <div id="subjectsList" class="space-y-3"></div>
    <div id="msg" class="mt-8 text-center text-slate-600 dark:text-slate-400"></div>
  </main>

  <footer class="site-ft">
    <div class="container mx-auto px-6 text-center text-sm">
      Â© <span id="yr"></span> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© | Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù…Ù†Ù‡Ø§Ø¬ Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù†
    </div>
  </footer>

  <script>
  document.getElementById('yr').textContent = new Date().getFullYear();

  const pathName = location.pathname, marker='/student/';
  const baseStudent = pathName.includes(marker) ? pathName.slice(0, pathName.indexOf(marker)+marker.length) : pathName.replace(/[^/]*$/,'');
  const HOME_URL = new URL(baseStudent + '../', location.origin).href;
  document.getElementById('homeLink').href = HOME_URL;

  document.getElementById('goBackBtn').addEventListener('click', ()=>{
    if (history.length > 1) history.back(); else location.href = HOME_URL;
  });

  (function initTheme(){
    const saved = localStorage.getItem('theme');
    if(saved==='dark' || (!saved && window.matchMedia && matchMedia('(prefers-color-scheme: dark)').matches)){
      document.documentElement.classList.add('dark');
    }
    document.getElementById('toggleTheme').addEventListener('click', ()=>{
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', document.documentElement.classList.contains('dark')?'dark':'light');
    });
  })();

  const API = baseStudent + '../admin.php';

  const params = new URLSearchParams(location.search);
  const gradeNo = +params.get('grade_no') || null;
  const gradeIdParam = +params.get('grade_id') || null;

  async function apiGet(action, p={}) {
    const u=new URL(API, location.origin); u.searchParams.set('action', action);
    Object.entries(p).forEach(([k,v])=>{ if(v!=='' && v!=null) u.searchParams.set(k,v); });
    const r=await fetch(u, {cache:'no-store'});
    const t=await r.text(); let j;
    try{ j=JSON.parse(t); }catch{ throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©'); }
    if(j.ok===false) throw new Error(j.error||'Ø®Ø·Ø£'); return j;
  }
  function gradeNameFromNo(n){
    const a=['','Ø§Ù„Ø£ÙˆÙ„','Ø§Ù„Ø«Ø§Ù†ÙŠ','Ø§Ù„Ø«Ø§Ù„Ø«','Ø§Ù„Ø±Ø§Ø¨Ø¹','Ø§Ù„Ø®Ø§Ù…Ø³','Ø§Ù„Ø³Ø§Ø¯Ø³','Ø§Ù„Ø³Ø§Ø¨Ø¹','Ø§Ù„Ø«Ø§Ù…Ù†','Ø§Ù„ØªØ§Ø³Ø¹','Ø§Ù„Ø¹Ø§Ø´Ø±','Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±','Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±'];
    return n>=1 && n<=12 ? 'Ø§Ù„ØµÙ '+a[n] : '';
  }

  let grade=null;
  async function resolveGrade(){
    const g = await apiGet('get_grades'); const rows=g.data||[];
    if(gradeIdParam){ grade = rows.find(x=>+x.id===gradeIdParam); return; }
    grade = rows.find(x=>+x.grade_no===gradeNo)
          || rows.find(x=>(x.name_ar||'').includes(gradeNameFromNo(gradeNo).replace('Ø§Ù„ØµÙ ','')));
  }

  function closeOtherTerms(exceptId){
    document.querySelectorAll('[data-terms]').forEach(el=>{
      if(el.id!==('t_'+exceptId)) el.classList.add('hidden');
    });
  }

  async function loadSubjects(){
    try{
      await resolveGrade();
      const hdr=document.getElementById('gradeHdr');
      if(!grade){ hdr.textContent='ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ.'; return; }
      hdr.innerHTML = `Ø§Ù„ØµÙ: <span class=\"font-extrabold text-blue-700 dark:text-blue-300\">${grade.name_ar || gradeNameFromNo(gradeNo)}</span>`;

      const res = await apiGet('get_subjects_by_grade',{grade_id:grade.id});
      const list = res.data||[];
      const box=document.getElementById('subjectsList'); box.innerHTML='';
      if(!list.length){ document.getElementById('msg').textContent='Ù„Ø§ Ù…ÙˆØ§Ø¯ Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ.'; return; }

      list.forEach((sub)=>{
        const wrap=document.createElement('div');
        wrap.innerHTML=`
          <button class=\"row-btn\" type=\"button\" data-sub=\"${sub.id}\">
            <span class=\"title\">${sub.name_ar}</span>
            <span class=\"chev\">â€º</span>
          </button>
          <div class=\"terms-bar hidden\" id=\"t_${sub.id}\" data-terms>
            <div class=\"flex items-center gap-2\">
              <span class=\"text-slate-700 dark:text-slate-300 font-semibold\">Ø§Ù„ÙØµÙ„:</span>
              <a class=\"pill\" href=\"exams.html?grade_id=${grade.id}&subject_id=${sub.id}&term_no=1\">Ø§Ù„Ø£ÙˆÙ„</a>
              <a class=\"pill\" href=\"exams.html?grade_id=${grade.id}&subject_id=${sub.id}&term_no=2\">Ø§Ù„Ø«Ø§Ù†ÙŠ</a>
            </div>
          </div>
        `;
        const btn = wrap.querySelector('.row-btn');
        const terms = wrap.querySelector('[data-terms]');
        btn.addEventListener('click', ()=>{
          const open = !terms.classList.contains('hidden');
          closeOtherTerms(sub.id);
          terms.classList.toggle('hidden', open);
          if(!open) terms.scrollIntoView({behavior:'smooth', block:'nearest'});
        });
        box.appendChild(wrap);
      });

    }catch(e){
      document.getElementById('msg').textContent='Ø®Ø·Ø£: '+e.message;
      console.error(e);
    }
  }
  loadSubjects();
  </script>
</body>
</html>